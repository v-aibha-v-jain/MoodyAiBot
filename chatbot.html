<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moody Ai ChatBot</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg, #181a20); margin: 0; padding: 0; color: var(--text, #e0e0e0); transition: background 0.3s, color 0.3s; }
        .chat-container { width: 90vw; height: 82vh; margin: 5vh auto; background: var(--container, #23272f); border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.4); padding: 4vh; transition: background 0.3s; }
        .chat-log { height: 65vh; overflow-y: scroll; border: 1px solid var(--container, #23272f); border-radius: 8px; padding: 4vw; background: var(--logbg, #181a20); margin-bottom: 18px; transition: background 0.3s; }
        .chat-message { display: flex; align-items: flex-end; margin: 12px 0; }
        .chat-message.user { flex-direction: row-reverse; justify-content: flex-end; }
        .chat-message.bot { flex-direction: row; justify-content: flex-start; }
        .chat-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--avatar, #1976d2); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; margin: 0 10px; box-shadow: 0 2px 8px rgba(25,118,210,0.15); transition: background 0.3s; }
        .chat-message.user .chat-avatar { background: var(--avatar, #1976d2); }
        .chat-message.bot .chat-avatar { background: var(--botavatar, #444857); }
        .chat-bubble { max-width: 70%; padding: 10px 16px; border-radius: 16px; font-size: 15px; line-height: 1.5; background: var(--bubble, #1976d2); color: #fff; box-shadow: 0 2px 8px rgba(25,118,210,0.08); transition: background 0.3s; }
        .chat-message.bot .chat-bubble { background: var(--botbubble, #23272f); color: var(--bottext, #e0e0e0); box-shadow: 0 2px 8px rgba(68,72,87,0.12); transition: background 0.3s, color 0.3s; }
        .chat-input-container { display: flex; }
        .chat-input { flex: 1; padding: 10px 12px; border: 1px solid var(--container, #23272f); border-radius: 6px; background: var(--inputbg, #2b2e35); color: var(--text, #e0e0e0); font-size: 15px; outline: none; transition: background 0.3s, color 0.3s; }
        .chat-input:focus { border-color: var(--accent, #1976d2); }
        .chat-send { padding: 10px 20px; background: var(--accent, #1976d2); color: #fff; border: none; border-radius: 6px; margin-left: 10px; cursor: pointer; font-size: 15px; transition: background 0.2s; }
        .chat-send:hover { background: var(--accentHover, #125ea2); }
        ::selection { background: var(--accent, #1976d2); color: #fff; }
        ::-webkit-scrollbar { width: 8px; background: #23272f; }
        ::-webkit-scrollbar-thumb { background: #444857; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div style="position: absolute; top: 24px; right: 32px; z-index: 20;">
            <div style="position: relative;">
                <button id="modesBtn" style="background: #23272f; color: #fff; border: 1px solid #444857; border-radius: 6px; padding: 7px 18px; font-size: 15px; cursor: pointer;">Modes (Normal) &#9662;</button>
                <div id="modesDropdown" style="display:none; position: absolute; right: 0; top: 110%; background: #23272f; border: 1px solid #444857; border-radius: 6px; min-width: 120px; box-shadow: 0 2px 8px rgba(0,0,0,0.18); z-index: 10;">
                    <div class="mode-option" data-mode="normal" style="padding: 10px 18px; cursor: pointer; color: #e0e0e0;">Normal</div>
                    <div class="mode-option" data-mode="fun" style="padding: 10px 18px; cursor: pointer; color: #e0e0e0;">Fun</div>
                    <div class="mode-option" data-mode="anger" style="padding: 10px 18px; cursor: pointer; color: #e0e0e0;">Anger</div>
                    <div class="mode-option" data-mode="love" style="padding: 10px 18px; cursor: pointer; color: #e0e0e0;">Love</div>
                    <div class="mode-option" data-mode="random" style="padding: 10px 18px; cursor: pointer; color: #e0e0e0;">Random</div>
                </div>
            </div>
        </div>
        <div class="chat-log" id="chatLog"></div>
        <form class="chat-input-container" id="chatForm">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." autocomplete="off" required />
            <button type="submit" class="chat-send">Send</button>
        </form>
    </div>
    <script>
        // Theme color sets for each mode
        const modeThemes = {
            normal: {
                '--bg': '#181a20', '--container': '#23272f', '--logbg': '#181a20', '--text': '#e0e0e0', '--avatar': '#1976d2', '--botavatar': '#444857', '--bubble': '#1976d2', '--botbubble': '#23272f', '--bottext': '#e0e0e0', '--inputbg': '#2b2e35', '--accent': '#1976d2', '--accentHover': '#125ea2'
            },
            fun: {
                '--bg': '#fffbe7', '--container': '#ffe082', '--logbg': '#fffde4', '--text': '#3e2723', '--avatar': '#ffb300', '--botavatar': '#ffd54f', '--bubble': '#ffb300', '--botbubble': '#ffe082', '--bottext': '#3e2723', '--inputbg': '#fffde4', '--accent': '#ffb300', '--accentHover': '#ffa000'
            },
            anger: {
                '--bg': '#2d0909', '--container': '#5a1a1a', '--logbg': '#2d0909', '--text': '#ffb3b3', '--avatar': '#d32f2f', '--botavatar': '#b71c1c', '--bubble': '#d32f2f', '--botbubble': '#5a1a1a', '--bottext': '#ffb3b3', '--inputbg': '#3a1313', '--accent': '#d32f2f', '--accentHover': '#b71c1c'
            },
            love: {
                '--bg': '#fff0f6', '--container': '#f8bbd0', '--logbg': '#fff0f6', '--text': '#ad1457', '--avatar': '#ec407a', '--botavatar': '#f06292', '--bubble': '#ec407a', '--botbubble': '#f8bbd0', '--bottext': '#ad1457', '--inputbg': '#fff0f6', '--accent': '#ec407a', '--accentHover': '#ad1457'
            },
            random: {
                '--bg': '#e3f2fd', '--container': '#90caf9', '--logbg': '#e3f2fd', '--text': '#0d47a1', '--avatar': '#1976d2', '--botavatar': '#64b5f6', '--bubble': '#1976d2', '--botbubble': '#90caf9', '--bottext': '#0d47a1', '--inputbg': '#e3f2fd', '--accent': '#1976d2', '--accentHover': '#0d47a1'
            }
        };

        function applyTheme(mode) {
            const theme = modeThemes[mode] || modeThemes['normal'];
            for (const key in theme) {
                document.documentElement.style.setProperty(key, theme[key]);
            }
        }

        let selectedMode = 'normal';
        // Initial theme
        applyTheme(selectedMode);
        // Modes dropdown logic
        const modesBtn = document.getElementById('modesBtn');
        const modesDropdown = document.getElementById('modesDropdown');

        modesBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            modesDropdown.style.display = modesDropdown.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', function() {
            modesDropdown.style.display = 'none';
        });

        document.querySelectorAll('.mode-option').forEach(function(opt) {
            opt.addEventListener('click', function(e) {
                selectedMode = this.getAttribute('data-mode');
                modesBtn.textContent = 'Modes (' + this.textContent + ') â–¼';
                modesDropdown.style.display = 'none';
                applyTheme(selectedMode);
            });
        });
        const chatLog = document.getElementById('chatLog');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        let conversation = [];

        function appendMessage(sender, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message ' + sender;

            // Avatar
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'chat-avatar';
            if (sender === 'user') {
                avatarDiv.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="8" r="4" fill="#fff"/><path d="M4 20c0-2.21 3.58-4 8-4s8 1.79 8 4" fill="#fff"/></svg>';
            } else {
                avatarDiv.innerHTML = '<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="robot" class="svg-inline--fa fa-robot" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="22" height="22"><path fill="#e0e0e0" d="M320 32a32 32 0 1 1 0 64 32 32 0 1 1 0-64zm-96 80h192c53 0 96 43 96 96v176c0 44.2-35.8 80-80 80v32a16 16 0 0 1-16 16h-32a16 16 0 0 1-16-16v-32h-96v32a16 16 0 0 1-16 16h-32a16 16 0 0 1-16-16v-32c-44.2 0-80-35.8-80-80V208c0-53 43-96 96-96zm-48 96v176c0 17.7 14.3 32 32 32h288c17.7 0 32-14.3 32-32V208c0-26.5-21.5-48-48-48H224c-26.5 0-48 21.5-48 48zm64 64a32 32 0 1 1 64 0 32 32 0 1 1-64 0zm160 0a32 32 0 1 1 64 0 32 32 0 1 1-64 0z"/></svg>';
            }

            // Bubble
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'chat-bubble';
            if (sender === 'bot') {
                let html = text;
                // Replace code blocks (```code```) with <pre>code</pre> on new lines
                html = html.replace(/```([\s\S]*?)```/g, function(match, code) {
                    return '<br><pre style="background:#181a20;color:#ffeb3b;padding:8px 12px;border-radius:8px;white-space:pre;overflow-x:scroll;margin:8px 0;">' + code.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</pre><br>';
                });
                // Replace **text** with <b>text</b>
                html = html.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');
                // Replace *text* with <i>text</i>
                html = html.replace(/\*([^*]+)\*/g, '<i>$1</i>');
                // Add <br> after every semicolon
                // Add <br> after every semicolon, except inside <pre>...</pre>
                html = html.replace(/(<pre[\s\S]*?<\/pre>)|;/g, function(match, p1) {
                    if (p1) return p1; // it's a <pre> block, return as is
                    return ';<br>';
                });
                bubbleDiv.innerHTML = html;
            } else {
                bubbleDiv.textContent = text;
            }

            if (sender === 'user') {
                msgDiv.appendChild(bubbleDiv);
                msgDiv.appendChild(avatarDiv);
            } else {
                msgDiv.appendChild(avatarDiv);
                msgDiv.appendChild(bubbleDiv);
            }
            chatLog.appendChild(msgDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Popup for API key
        function showApiKeyPopup() {
            let popup = document.getElementById('apiKeyPopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'apiKeyPopup';
                popup.style.position = 'fixed';
                popup.style.top = '0';
                popup.style.left = '0';
                popup.style.width = '100vw';
                popup.style.height = '100vh';
                popup.style.background = 'rgba(0,0,0,0.7)';
                popup.style.display = 'flex';
                popup.style.alignItems = 'center';
                popup.style.justifyContent = 'center';
                popup.innerHTML = `
                    <div style="background:#23272f;padding:32px 28px;border-radius:12px;box-shadow:0 2px 16px #0006;min-width:320px;max-width:90vw;">
                        <h2 style="color:#fff;margin-top:0;">API Key Required</h2>
                        <p style="color:#e0e0e0;">Your API key is invalid or out of credits.<br>Please enter a new Google AI API key:</p>
                        <input id="apiKeyInput" type="text" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #444857;background:#181a20;color:#fff;font-size:15px;margin-bottom:16px;" placeholder="Enter API Key..." />
                        <button id="apiKeySaveBtn" style="background:#1976d2;color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:15px;cursor:pointer;">Save</button>
                    </div>
                `;
                document.body.appendChild(popup);
                document.getElementById('apiKeySaveBtn').onclick = function() {
                    const newKey = document.getElementById('apiKeyInput').value.trim();
                    if (newKey) {
                        localStorage.setItem('googleai_api_key', newKey);
                        popup.remove();
                        window.location.reload();
                    }
                };
            }
        }

        async function sendMessageToBot(userMsg) {
            conversation.push(userMsg);
            try {
                const apiKey = localStorage.getItem('googleai_api_key') || '';
                const response = await fetch('https://moodyai.onrender.com/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: conversation, mode: selectedMode, api_key: apiKey })
                });
                const data = await response.json();
                if (data.response) {
                    appendMessage('bot', data.response);
                    conversation.push(data.response);
                } else {
                    // Check for API key/credit error
                    if ((data.error || '').toLowerCase().includes('api key') || (data.error || '').toLowerCase().includes('credit')) {
                        showApiKeyPopup();
                    }
                    appendMessage('bot', 'Error: ' + (data.error || 'No response'));
                }
            } catch (err) {
                appendMessage('bot', 'Error: Could not reach server.');
            }
        }

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const userMsg = chatInput.value.trim();
            if (!userMsg) return;
            appendMessage('user', userMsg);
            chatInput.value = '';
            sendMessageToBot(userMsg);
        });
    </script>
</body>
</html>
